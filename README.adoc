= Ubuntu 20.04 Desktop Playbook
Jordan Williams <jordan@jwillikers.com>
:experimental:
:icons: font
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

An Ansible playbook to configure the Ubuntu 20.04 desktop to my liking.

== Prerequisites

This project uses Ansible, Python, Molecule, and Podman.
asdf is used to manage the Python runtime along with direnv and Pipenv to manage the project's virtual environment and Python dependencies.
This promotes flexible, cross-distribution environments and makes builds more reproducible.
Instructions for installing everything are provided below.

. Install the dependencies needed for asdf.
+
[source,sh]
----
âžœ sudo apt -y install curl git
----

. If you use Btrfs and want to exclude the `~/.asdf` directory from snapshots of your home directory, create a subvolume for it.
+ 
[source,sh]
----
âžœ btrfs subvolume create ~/.asdf
----

. Pull down the https://github.com/asdf-vm/asdf[asdf repository] in to your home directory.
+
[source,sh]
----
âžœ git clone https://github.com/asdf-vm/asdf.git ~/.asdf
Cloning into '/home/ubuntu/.asdf'...
remote: Enumerating objects: 145, done.
remote: Counting objects: 100% (145/145), done.
remote: Compressing objects: 100% (85/85), done.
remote: Total 5782 (delta 76), reused 93 (delta 59), pack-reused 5637
Receiving objects: 100% (5782/5782), 1.09 MiB | 6.01 MiB/s, done.
Resolving deltas: 100% (3293/3293), done.
----

. Checkout the latest version of asdf.
+
--
_fish_::
+
[source,sh]
----
âžœ git -C ~/.asdf switch --detach (git -C ~/.asdf describe --abbrev=0 --tags)
HEAD is now at c6145d0 Update version to 0.8.0
----

_Bash / ZSH_::
+
[source,bash]
----
âžœ git -C ~/.asdf switch --detach $(git -C ~/.asdf describe --abbrev=0 --tags)
HEAD is now at c6145d0 Update version to 0.8.0
----
--

. Enable asdf in your shell.
+
--
_fish_::
+
[source,sh]
----
âžœ mkdir -p ~/.config/fish/conf.d; \
  and echo "source ~/.asdf/asdf.fish" > ~/.config/fish/conf.d/asdf.fish
----

_Bash_::
+
[source,bash]
----
âžœ echo '. $HOME/.asdf/asdf.sh' >> ~/.bashrc
----

_ZSH_::
+
[source,zsh]
----
âžœ echo '. $HOME/.asdf/asdf.sh' >> ~/.zshrc
----
--

. Install shell completions for asdf.
+
--
_fish_::
+
[source,sh]
----
âžœ mkdir -p ~/.config/fish/completions; \
  and ln -s ~/.asdf/completions/asdf.fish ~/.config/fish/completions
----

_Bash_::
+
[source,bash]
----
âžœ echo '. $HOME/.asdf/completions/asdf.bash' >> ~/.bashrc
----

_ZSH_::
+
[source,zsh]
----
âžœ echo -e 'fpath=(${ASDF_DIR}/completions $fpath)\nautoload -Uz compinit\ncompinit' >> ~/.zshrc
----
--

. To make asdf available, reload your shell.
+
--
_fish_::
+
[source,sh]
----
âžœ exec fish
----

_Bash_::
+
[source,bash]
----
âžœ source ~/.bashrc
----

_ZSH_::
+
[source,zsh]
----
âžœ source ~/.zshrc
----
--

. Install the necessary dependencies to build Python which are helpfully documented in the https://github.com/pyenv/pyenv/wiki#suggested-build-environment[Pyenv Wiki].
+
[source,sh]
----
âžœ sudo apt -y install make build-essential libssl-dev zlib1g-dev libbz2-dev \
  libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev xz-utils \
  tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev
----

. Add the https://github.com/danhper/asdf-python[Python plugin] to asdf.
+
[source,sh]
----
âžœ asdf plugin add python
initializing plugin repository...
Cloning into '/home/ubuntu/.asdf/repository'...
remote: Enumerating objects: 2450, done.
remote: Total 2450 (delta 0), reused 0 (delta 0), pack-reused 2450
Receiving objects: 100% (2450/2450), 553.27 KiB | 3.57 MiB/s, done.
Resolving deltas: 100% (1140/1140), done.
----

. Before installing Pipenv, configure the default _global_ Python version for the user.
+
--
You can use the system version of Python by default or another version of your choice.

[IMPORTANT]
====
Whenever the user's global version of Python is updated, Pipenv must be reinstalled which may require that all virtual environments be rebuilt.
====

--

** Use the system's Python as the default.

... Ubuntu installs Python as either `python2` or `python3` on the system.
+
--
This means that asdf won't be able to detect the system version of python.
Install the Python package `python-is-python3` to install a `python` executable for the system which uses `python3`.

[source,sh]
----
âžœ sudo apt -y install python-is-python3
----
--

... Install pip and venv because they are not installed by default on Ubuntu.
+
[source,sh]
----
âžœ sudo apt -y install python3-pip python3-venv
----

... Set the user's Python to the system-wide version.
+
[source,sh]
----
âžœ asdf global python system
----

** Or, you can use another version of Python for your user such as the latest and greatest version.

... Build and install the latest version of Python.
+
[source,sh]
----
âžœ asdf install python latest
----

... Set the user's Python to the latest version available at this time.
+
--
_fish_::
+
[source,sh]
----
âžœ asdf global python (asdf latest python)
----

_Bash / ZSH_::
+
[source,bash]
----
âžœ asdf global python $(asdf latest python)
----
--

. Install https://pipxproject.github.io/pipx/[pipx] for installing Pipenv in an isolated environment.
+
[source,sh]
----
âžœ python -m pip install --user pipx
Collecting pipx
  Downloading pipx-0.15.6.0-py3-none-any.whl (43 kB)
     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 43 kB 636 kB/s
Collecting argcomplete<2.0,>=1.9.4
  Downloading argcomplete-1.12.1-py2.py3-none-any.whl (38 kB)
Collecting packaging>=20.0
  Downloading packaging-20.4-py2.py3-none-any.whl (37 kB)
Collecting userpath>=1.4.1
  Downloading userpath-1.4.1-py2.py3-none-any.whl (14 kB)
Collecting pyparsing>=2.0.2
  Downloading pyparsing-2.4.7-py2.py3-none-any.whl (67 kB)
     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 67 kB 1.4 MB/s
Requirement already satisfied: six in /usr/lib/python3/dist-packages (from packaging>=20.0->pipx) (1.14.0)
Requirement already satisfied: click in /usr/lib/python3/dist-packages (from userpath>=1.4.1->pipx) (7.0)
Requirement already satisfied: distro; platform_system == "Linux" in /usr/lib/python3/dist-packages (from userpath>=1.4.1->pipx) (1.4.0)
Installing collected packages: argcomplete, pyparsing, packaging, userpath, pipx
  WARNING: The script userpath is installed in '/home/ubuntu/.local/bin' which is not on PATH.
  Consider adding this directory to PATH or, if you prefer to suppress this warning, use --no-warn-script-location.
  WARNING: The script pipx is installed in '/home/ubuntu/.local/bin' which is not on PATH.
  Consider adding this directory to PATH or, if you prefer to suppress this warning, use --no-warn-script-location.
Successfully installed argcomplete-1.12.1 packaging-20.4 pipx-0.15.6.0 pyparsing-2.4.7 userpath-1.4.1
----

. Add the directory where pip installs executables for the local user to `PATH`.
+
[source,sh]
----
âžœ python -m pipx ensurepath
Success! Added /home/ubuntu/.local/bin to the PATH environment
    variable.
/home/ubuntu/.local/bin has been been added to PATH, but you need to
    open a new terminal or re-login for this PATH change to take
    effect.

Consider adding shell completions for pipx. Run 'pipx completions' for
instructions.

You will need to open a new terminal or re-login for the PATH changes
to take effect.

Otherwise pipx is ready to go! âœ¨ ðŸŒŸ âœ¨
----

. To make executables installed by pipx available, reload your shell.
+
--
_fish_::
+
[source,sh]
----
âžœ exec fish
----

_Bash_::
+
[source,bash]
----
âžœ source ~/.bashrc
----

_ZSH_::
+
[source,zsh]
----
âžœ source ~/.zshrc
----
--

. Install Pipenv.
+
[source,sh]
----
âžœ python -m pipx install pipenv
  installed package pipenv 2020.8.13, Python 3.8.5
  These apps are now globally available
    - pipenv
    - pipenv-resolver
done! âœ¨ ðŸŒŸ âœ¨
----

. Add the direnv plugin to asdf.
+
[source,sh]
----
âžœ asdf plugin add direnv
----

. Integrate direnv with your shell.
+
--
_fish_::
+
[source,sh]
----
âžœ mkdir -p ~/.config/fish/conf.d; \
  and echo "asdf exec direnv hook fish | source" > ~/.config/fish/conf.d/direnv.fish
----

_Bash_::
+
[source,bash]
----
âžœ echo 'eval "$(asdf exec direnv hook bash)"' >> ~/.bashrc
----

_ZSH_::
+
[source,zsh]
----
âžœ echo 'eval "$(asdf exec direnv hook zsh)"' >> ~/.zshrc
----
--

. Make the asdf feature, i.e. the command `use asdf`, available in direnv.
+
--
_fish_::
+
[source,sh]
----
âžœ mkdir -p ~/.config/direnv; \
  and echo 'source "$(asdf direnv hook asdf)"' >> ~/.config/direnv/direnvrc
----

_Bash / ZSH_::
+
[source,bash]
----
âžœ mkdir -p ~/.config/direnv; echo 'source "$(asdf direnv hook asdf)"' >> ~/.config/direnv/direnvrc
----

NOTE: The `direnvrc` file should only use Bash syntax.
--

. Add completions for Pipenv to your shell.
+
--
_fish_::
+
[source,sh]
----
âžœ echo "eval (pipenv --completion)" > ~/.config/fish/completions/pipenv.fish
----

_Bash_::
+
[source,bash]
----
âžœ echo 'eval "$(pipenv --completion)"' >> ~/.bashrc
----

_ZSH_::
+
[source,zsh]
----
âžœ echo 'eval "$(pipenv --completion)"' >> ~/.zshrc
----
--

. Clone this project's Git repository.
+
[source,sh]
----
âžœ git clone https://github.com/jwillikers/ubuntu-20.04-desktop-playbook.git ~/Projects/ubuntu-20.04-desktop-playbook
----

. Change to the project directory.
+
[source,sh]
----
âžœ cd ~/Projects/ubuntu-20.04-desktop-playbook
----

. Run asdf to automatically install Python and direnv.
+
--
[source,sh]
----
âžœ asdf install
âˆ— Downloading and installing direnv...
The installation was successful!
Downloading python-build...
Cloning into '/home/ubuntu/.asdf/plugins/python/pyenv'...
remote: Enumerating objects: 19, done.
remote: Counting objects: 100% (19/19), done.
remote: Compressing objects: 100% (16/16), done.
remote: Total 18370 (delta 3), reused 10 (delta 2), pack-reused 18351
Receiving objects: 100% (18370/18370), 3.70 MiB | 6.55 MiB/s, done.
Resolving deltas: 100% (12507/12507), done.
python-build 3.9.0 /home/ubuntu/.asdf/installs/python/3.9.0
Downloading Python-3.9.0.tar.xz...
-> https://www.python.org/ftp/python/3.9.0/Python-3.9.0.tar.xz
Installing Python-3.9.0...
Installed Python-3.9.0 to /home/ubuntu/.asdf/installs/python/3.9.0
----

[TIP]
====
If you haven't set a default global version of direnv, you should do so now.

_fish_::
+
[source,sh]
----
âžœ asdf global direnv (asdf list direnv | awk 'FNR <= 1')
----

_Bash / ZSH_::
+
[source,sh]
----
âžœ asdf global direnv $(asdf list direnv | awk 'FNR <= 1')
----
====
--

. Reload your shell for direnv to be available.
+
--
_fish_::
+
[source,sh]
----
âžœ exec fish
direnv: error /home/ubuntu/Source/MyProject/.envrc is blocked. Run `direnv allow` to approve its content
----

_Bash_::
+
[source,bash]
----
âžœ source ~/.bashrc
direnv: error /home/ubuntu/Source/MyProject/.envrc is blocked. Run `direnv allow` to approve its content
----

_ZSH_::
+
[source,zsh]
----
âžœ source ~/.zshrc
direnv: error /home/ubuntu/Source/MyProject/.envrc is blocked. Run `direnv allow` to approve its content
----
--

. Enable automatic loading of the project's environment.
+
[source,sh]
----
âžœ direnv allow
direnv: loading ~/Source/MyProject/.envrc
direnv: using asdf
direnv: Creating env file /home/ubuntu/.asdf/installs/direnv/2.23.1/env/3889178603-777313312-2662766433-906191085
direnv: loading ~/.asdf/installs/direnv/2.23.1/env/3889178603-777313312-2662766433-906191085
direnv: using asdf direnv 2.23.1
direnv: using asdf python 3.9.0
Creating a virtualenv for this projectâ€¦
Pipfile: /home/ubuntu/Source/MyProject/Pipfile
Using /home/ubuntu/.asdf/installs/python/3.9.0/bin/python3.9 (3.9.0) to create virtualenvâ€¦
â § Creating virtual environment...direnv: ([/home/ubuntu/.asdf/installs/direnv/2.23.1/bin/direnv export bash]) is taking a while to execute. Use CTRL-C to give up.
â ¦ Creating virtual environment...created virtual environment CPython3.9.0.final.0-64 in 1759ms
  creator CPython3Posix(dest=/home/ubuntu/.local/share/virtualenvs/MyProject-6C2lAvdi, clear=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/ubuntu/.local/share/virtualenv)
    added seed packages: pip==20.2.4, setuptools==50.3.2, wheel==0.35.1
  activators BashActivator,CShellActivator,FishActivator,PowerShellActivator,PythonActivator,XonshActivator

âœ” Successfully created virtual environment!
Virtualenv location: /home/ubuntu/.local/share/virtualenvs/MyProject-6C2lAvdi
Installing dependencies from Pipfile.lock (df42de)â€¦
  ðŸ   â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰ 26/26 â€” 00:01:09
To activate this project's virtualenv, run pipenv shell.
Alternatively, run a command inside the virtualenv with pipenv run.
direnv: export +PIPENV_ACTIVE +VIRTUAL_ENV ~PATH
----

Now, whenever you change into the project directory, the project's virtual environment will automatically be loaded for you.

== Test

To create the container, run everything, test, and subsequently destroy the container, use `molecule test` from the project directory.

[source,sh]
----
âžœ molecule test
----

// == Deploy
// todo: To deploy the playbook to the target devices...

== References

For further reading on the use of Ansible, Molecule, and Podman, see Ansible's blog post series, Developing and Testing Ansible Roles with Molecule and Podman_.

* https://www.ansible.com/blog/developing-and-testing-ansible-roles-with-molecule-and-podman-part-1[Part 1]
* https://www.ansible.com/blog/developing-and-testing-ansible-roles-with-molecule-and-podman-part-2[Part 2]

== Contributing

Contributions in the form of issues, feedback, and even pull requests are welcome.
Make sure to adhere to the project's link:CODE_OF_CONDUCT.adoc[Code of Conduct].

== Open Source Software

This project is built on the hard work of countless open source contributors.
Several of these projects are enumerated below.

* https://www.ansible.com/[Ansible]
* https://asciidoctor.org/[Asciidoctor]
* https://asdf-vm.com/#/[asdf]
* https://www.debian.org/[Debian]
* https://direnv.net/[direnv]
* https://git-scm.com/[Git]
* https://www.linuxfoundation.org/[Linux]
* https://molecule.readthedocs.io/en/latest/[Molecule]
* https://www.openssh.com/[OpenSSH]
* https://pipenv.pypa.io/en/latest/[Pipenv]
* https://podman.io/[Podman]
* https://www.python.org/[Python]
* https://rouge.jneen.net/[Rouge]
* https://www.ruby-lang.org/en/[Ruby]
* https://ubuntu.com/[Ubuntu]

== Code of Conduct

The project's Code of Conduct is available in the link:CODE_OF_CONDUCT.adoc[Code of Conduct] file.

== License

This repository is licensed under the https://www.gnu.org/licenses/gpl-3.0.html[GPLv3], available in the link:LICENSE.adoc[license file].

Â© 2021 Jordan Williams

== Authors

mailto:{email}[{author}]
